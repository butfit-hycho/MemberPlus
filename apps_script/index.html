<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>ìœ íš¨íšŒì›/íœ´ë©´íšŒì› ì¶”ì¶œ ì‹œìŠ¤í…œ</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            max-width: 700px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 24px;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
        }
        
        select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            background-color: white;
            box-sizing: border-box;
        }
        
        select:focus {
            outline: none;
            border-color: #4CAF50;
        }
        
        .button-group {
            text-align: center;
            margin-top: 30px;
        }
        
        button {
            background-color: #4CAF50;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 0 10px;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background-color: #45a049;
        }
        
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        
        .secondary-btn {
            background-color: #2196F3;
        }
        
        .secondary-btn:hover {
            background-color: #1976D2;
        }
        
        .danger-btn {
            background-color: #f44336;
        }
        
        .danger-btn:hover {
            background-color: #d32f2f;
        }
        
        .status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 5px;
            display: none;
        }
        
        .status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status.info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .progress {
            margin-top: 20px;
            display: none;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background-color: #4CAF50;
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .progress-text {
            text-align: center;
            margin-top: 10px;
            font-size: 14px;
            color: #666;
        }
        
        .info-box {
            background-color: #e8f5e8;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            border-left: 4px solid #4CAF50;
        }
        
        .info-box h3 {
            margin-top: 0;
            color: #2e7d32;
        }
        
        .info-box ul {
            margin: 10px 0;
            padding-left: 20px;
        }
        
        .info-box li {
            margin: 5px 0;
            color: #555;
        }
        
        .result-box {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin-top: 20px;
            display: none;
        }
        
        .result-box h3 {
            margin-top: 0;
            color: #495057;
        }
        
        .result-item {
            margin: 8px 0;
            padding: 8px;
            background-color: white;
            border-radius: 3px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .result-item strong {
            color: #333;
        }
        
        .result-count {
            background-color: #4CAF50;
            color: white;
            padding: 4px 8px;
            border-radius: 15px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“Š ìœ íš¨íšŒì›/íœ´ë©´íšŒì› ì¶”ì¶œ ì‹œìŠ¤í…œ</h1>
        
        <div class="info-box">
            <h3>ğŸ” ì‹œìŠ¤í…œ ì •ë³´</h3>
            <ul>
                <li><strong>ë°ì´í„°ë² ì´ìŠ¤:</strong> ë ˆí”Œë¦¬ì¹´ DB (ì½ê¸° ì „ìš©)</li>
                <li><strong>ì¶”ì¶œ ë°ì´í„°:</strong> ìœ íš¨íšŒì›, íœ´ë©´íšŒì› ë¶„ë¥˜</li>
                <li><strong>ê²°ê³¼ ì €ì¥:</strong> ì§€ì ë³„ êµ¬ê¸€ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì‹œíŠ¸</li>
                <li><strong>ë™ì‹œ ì‚¬ìš©:</strong> ì—¬ëŸ¬ ì§€ì  ë™ì‹œ ì¶”ì¶œ ê°€ëŠ¥</li>
            </ul>
        </div>
        
        <div class="form-group">
            <label for="branchSelect">ğŸ“ ì§€ì  ì„ íƒ</label>
            <select id="branchSelect">
                <option value="">ì§€ì ì„ ì„ íƒí•˜ì„¸ìš”...</option>
                <option value="ì „ì²´">ì „ì²´</option>
            </select>
        </div>
        
        <div class="button-group">
            <button id="refreshBtn" class="secondary-btn" onclick="refreshBranches()">
                ğŸ”„ ì§€ì  ëª©ë¡ ìƒˆë¡œê³ ì¹¨
            </button>
            <button id="extractBtn" onclick="startExtraction()">
                ğŸš€ ë°ì´í„° ì¶”ì¶œ ì‹œì‘
            </button>
            <button id="testBtn" class="danger-btn" onclick="testConnection()">
                ğŸ§ª ì—°ê²° í…ŒìŠ¤íŠ¸
            </button>
        </div>
        
        <div id="progress" class="progress">
            <div class="progress-bar">
                <div id="progressFill" class="progress-fill"></div>
            </div>
            <div id="progressText" class="progress-text">ì¤€ë¹„ ì¤‘...</div>
        </div>
        
        <div id="status" class="status"></div>
        
        <div id="resultBox" class="result-box">
            <h3>ğŸ“‹ ì¶”ì¶œ ê²°ê³¼</h3>
            <div id="resultContent"></div>
            <div style="text-align: center; margin-top: 15px;">
                <button id="openSheetBtn" class="secondary-btn" onclick="openSpreadsheet()">
                    ğŸ“„ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì—´ê¸°
                </button>
            </div>
        </div>
    </div>

    <script>
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì§€ì  ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
        window.onload = function() {
            refreshBranches();
        };
        
        // ì§€ì  ëª©ë¡ ìƒˆë¡œê³ ì¹¨
        function refreshBranches() {
            showStatus('ì§€ì  ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...', 'info');
            setButtonsEnabled(false);
            
            google.script.run
                .withSuccessHandler(onBranchesLoaded)
                .withFailureHandler(onError)
                .getBranches();
        }
        
        // ì§€ì  ëª©ë¡ ë¡œë“œ ì„±ê³µ
        function onBranchesLoaded(branches) {
            const select = document.getElementById('branchSelect');
            select.innerHTML = '<option value="">ì§€ì ì„ ì„ íƒí•˜ì„¸ìš”...</option>';
            
            branches.forEach(branch => {
                const option = document.createElement('option');
                option.value = branch;
                option.textContent = branch;
                select.appendChild(option);
            });
            
            showStatus(`ì´ ${branches.length}ê°œ ì§€ì ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.`, 'success');
            setButtonsEnabled(true);
        }
        
        // ì—°ê²° í…ŒìŠ¤íŠ¸
        function testConnection() {
            showStatus('ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°ì„ í…ŒìŠ¤íŠ¸í•˜ëŠ” ì¤‘...', 'info');
            setButtonsEnabled(false);
            
            google.script.run
                .withSuccessHandler(onTestResult)
                .withFailureHandler(onError)
                .testConnection();
        }
        
        // ì—°ê²° í…ŒìŠ¤íŠ¸ ê²°ê³¼
        function onTestResult(result) {
            if (result.success) {
                showStatus('âœ… ' + result.message, 'success');
            } else {
                showStatus('âŒ ' + result.message, 'error');
            }
            setButtonsEnabled(true);
        }
        
        // ë°ì´í„° ì¶”ì¶œ ì‹œì‘
        function startExtraction() {
            const branchSelect = document.getElementById('branchSelect');
            const selectedBranch = branchSelect.value;
            
            if (!selectedBranch) {
                showStatus('âŒ ì§€ì ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
                return;
            }
            
            showStatus(`ğŸ”„ ${selectedBranch} ì§€ì  ë°ì´í„°ë¥¼ ì¶”ì¶œí•˜ëŠ” ì¤‘...`, 'info');
            showProgress(true);
            setButtonsEnabled(false);
            
            // ì§„í–‰ë¥  ì• ë‹ˆë©”ì´ì…˜
            updateProgress(20, 'ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì¤‘...');
            
            setTimeout(() => {
                updateProgress(40, 'ìœ íš¨íšŒì› ë°ì´í„° ì¶”ì¶œ ì¤‘...');
            }, 1000);
            
            setTimeout(() => {
                updateProgress(60, 'íœ´ë©´íšŒì› ë°ì´í„° ì¶”ì¶œ ì¤‘...');
            }, 2000);
            
            setTimeout(() => {
                updateProgress(80, 'êµ¬ê¸€ ì‹œíŠ¸ ì—…ë¡œë“œ ì¤‘...');
            }, 3000);
            
            google.script.run
                .withSuccessHandler(onExtractionComplete)
                .withFailureHandler(onError)
                .extractAndUploadData(selectedBranch);
        }
        
        // ë°ì´í„° ì¶”ì¶œ ì™„ë£Œ
        function onExtractionComplete(result) {
            updateProgress(100, 'ì™„ë£Œ!');
            
            setTimeout(() => {
                showProgress(false);
                setButtonsEnabled(true);
                
                if (result.success) {
                    showStatus('âœ… ' + result.message, 'success');
                    showResult(result);
                } else {
                    showStatus('âŒ ' + result.message, 'error');
                }
            }, 500);
        }
        
        // ê²°ê³¼ í‘œì‹œ
        function showResult(result) {
            const resultBox = document.getElementById('resultBox');
            const resultContent = document.getElementById('resultContent');
            
            resultContent.innerHTML = `
                <div class="result-item">
                    <strong>ìœ íš¨íšŒì›</strong>
                    <span class="result-count">${result.activeCount - 1}ëª…</span>
                </div>
                <div class="result-item">
                    <strong>íœ´ë©´íšŒì›</strong>
                    <span class="result-count">${result.inactiveCount - 1}ëª…</span>
                </div>
                <div class="result-item">
                    <strong>ìƒì„±ëœ ì‹œíŠ¸</strong>
                    <span class="result-count">${result.sheets.length}ê°œ</span>
                </div>
            `;
            
            resultBox.style.display = 'block';
        }
        
        // ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì—´ê¸°
        function openSpreadsheet() {
            google.script.run
                .withSuccessHandler(function(url) {
                    window.open(url, '_blank');
                })
                .withFailureHandler(onError)
                .getSpreadsheetUrl();
        }
        
        // ì§„í–‰ë¥  í‘œì‹œ
        function showProgress(show) {
            const progress = document.getElementById('progress');
            progress.style.display = show ? 'block' : 'none';
            
            if (!show) {
                updateProgress(0, '');
            }
        }
        
        // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
        function updateProgress(percentage, text) {
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            
            progressFill.style.width = percentage + '%';
            progressText.textContent = text;
        }
        
        // ìƒíƒœ ë©”ì‹œì§€ í‘œì‹œ
        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.className = `status ${type}`;
            status.textContent = message;
            status.style.display = 'block';
            
            // 3ì´ˆ í›„ ìë™ìœ¼ë¡œ ìˆ¨ê¸°ê¸° (ì—ëŸ¬ ë©”ì‹œì§€ ì œì™¸)
            if (type !== 'error') {
                setTimeout(() => {
                    status.style.display = 'none';
                }, 3000);
            }
        }
        
        // ë²„íŠ¼ í™œì„±í™”/ë¹„í™œì„±í™”
        function setButtonsEnabled(enabled) {
            const buttons = ['refreshBtn', 'extractBtn', 'testBtn'];
            buttons.forEach(id => {
                document.getElementById(id).disabled = !enabled;
            });
        }
        
        // ì—ëŸ¬ ì²˜ë¦¬
        function onError(error) {
            showStatus('âŒ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
            showProgress(false);
            setButtonsEnabled(true);
            console.error('Error:', error);
        }
    </script>
</body>
</html> 